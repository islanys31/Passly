<!DOCTYPE html>
<html lang="es" data-theme="dark">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Passly - Esc√°ner QR</title>
    <link rel="stylesheet" href="/css/index.css">
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
</head>

<body style="background: var(--bg-primary); overflow: hidden;">
    <div style="max-width: 600px; margin: 0 auto; padding: 20px; height: 100vh; display: flex; flex-direction: column;">
        <div style="text-align: center; margin-bottom: 20px;">
            <h1
                style="background: linear-gradient(135deg, var(--accent-green), var(--accent-blue)); -webkit-background-clip: text; background-clip: text; -webkit-text-fill-color: transparent; font-size: 32px; margin-bottom: 10px;">
                üîç Esc√°ner Passly</h1>
            <p style="color: var(--text-muted); font-size: 14px;">Apunta la c√°mara al c√≥digo QR del usuario</p>
        </div>

        <div class="card" style="flex: 1; display: flex; flex-direction: column; padding: 20px;">
            <div id="reader"
                style="width: 100%; max-width: 500px; margin: 0 auto; border-radius: 12px; overflow: hidden;"></div>

            <div id="result" style="margin-top: 20px; text-align: center; display: none;">
                <div id="userPhoto"
                    style="width: 120px; height: 120px; margin: 0 auto 15px; border-radius: 50%; background: var(--bg-secondary); display: flex; align-items: center; justify-content: center; font-size: 48px; border: 4px solid var(--accent-green); overflow: hidden;">
                    üë§
                </div>
                <h2 id="userName" style="color: var(--accent-green); margin-bottom: 5px;">-</h2>
                <p id="userType" style="color: var(--text-muted); font-size: 14px; margin-bottom: 20px;">-</p>
                <div class="badge badge-success" style="font-size: 16px; padding: 10px 20px;">‚úì Acceso Autorizado</div>
            </div>

            <div id="error"
                style="margin-top: 20px; padding: 15px; background: rgba(239,68,68,0.1); border: 2px solid var(--error-color); border-radius: 12px; display: none; text-align: center;">
                <p style="color: var(--error-color); font-weight: 600; margin: 0;" id="errorMsg">Error</p>
            </div>
        </div>

        <div style="display: flex; gap: 10px; margin-top: 20px;">
            <button onclick="location.href='dashboard.html'"
                style="flex: 1; background: var(--bg-secondary); color: white; border: none; padding: 12px; border-radius: 12px; font-weight: 600; cursor: pointer;">‚Üê
                Volver al Panel</button>
            <button id="btnReset" onclick="resetScanner()"
                style="flex: 1; background: var(--accent-blue); color: white; border: none; padding: 12px; border-radius: 12px; font-weight: 600; cursor: pointer; display: none;">Escanear
                Otro</button>
        </div>
    </div>

    <script type="module">
        import { apiRequest } from '/js/api.js';
        import { showToast } from '/js/utils.js';

        let html5QrCode;
        const resultDiv = document.getElementById('result');
        const errorDiv = document.getElementById('error');
        const resetBtn = document.getElementById('btnReset');

        function onScanSuccess(decodedText, decodedResult) {
            html5QrCode.stop().then(() => {
                processQR(decodedText);
            });
        }

        async function processQR(scanData) {
            const res = await apiRequest('/accesos/scan', 'POST', { scanData });

            if (res.ok) {
                const data = res.data.data;
                document.getElementById('userName').textContent = data.nombre;
                document.getElementById('userType').textContent = data.esInvitado ? 'üé´ Invitado Temporal' : 'üîë Usuario Permanente';

                const photoDiv = document.getElementById('userPhoto');
                if (data.foto) {
                    photoDiv.innerHTML = `<img src="${data.foto}" style="width: 100%; height: 100%; object-fit: cover;">`;
                } else {
                    photoDiv.innerHTML = data.nombre.charAt(0).toUpperCase();
                    photoDiv.style.fontSize = '48px';
                    photoDiv.style.background = 'linear-gradient(135deg, var(--accent-green), var(--accent-blue))';
                    photoDiv.style.color = 'white';
                }

                resultDiv.style.display = 'block';
                resetBtn.style.display = 'block';
                showToast(`Acceso registrado: ${data.nombre}`, 'success');
            } else {
                errorDiv.style.display = 'block';
                document.getElementById('errorMsg').textContent = res.data?.error || 'QR inv√°lido o expirado';
                resetBtn.style.display = 'block';
            }
        }

        window.resetScanner = function () {
            resultDiv.style.display = 'none';
            errorDiv.style.display = 'none';
            resetBtn.style.display = 'none';
            startScanner();
        };

        async function startScanner() {
            if (typeof Html5Qrcode === 'undefined') {
                console.error('Html5Qrcode library not loaded');
                errorDiv.style.display = 'block';
                document.getElementById('errorMsg').innerHTML = '‚åõ Cargando motor de escaneo... <br><small>Si el error persiste, verifica tu conexi√≥n a internet.</small>';
                setTimeout(startScanner, 2000); // Reintento autom√°tico
                return;
            }

            try {
                if (html5QrCode) await html5QrCode.stop().catch(() => { });
                html5QrCode = new Html5Qrcode("reader");

                await html5QrCode.start(
                    { facingMode: "environment" },
                    { fps: 15, qrbox: { width: 250, height: 250 } },
                    onScanSuccess
                );

                errorDiv.style.display = 'none';
                console.log('Scanner iniciado correctamente');
            } catch (err) {
                console.error('Error al iniciar c√°mara:', err);
                errorDiv.style.display = 'block';
                let msg = 'No se pudo acceder a la c√°mara.';

                if (err.name === 'NotAllowedError') msg += ' Permiso denegado por el navegador.';
                else if (err.name === 'NotFoundError') msg += ' No se encontr√≥ ninguna c√°mara.';
                else if (location.protocol !== 'https:' && location.hostname !== 'localhost') msg += ' <br><strong>Error de Seguridad:</strong> El navegador solo permite la c√°mara en conexiones seguras (HTTPS).';

                document.getElementById('errorMsg').innerHTML = msg + '<br><button onclick="location.reload()" style="background:var(--accent-blue); color:white; border:none; padding:5px 10px; border-radius:5px; margin-top:10px; cursor:pointer;">Reintentar</button>';
            }
        }

        // Iniciar con un peque√±o retardo para asegurar que el DOM y la librer√≠a est√©n listos
        setTimeout(startScanner, 1000);
    </script>
</body>

</html>